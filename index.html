<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>کشف الدرجات - ڈیجیٹل</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#004d40">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <!-- PDF بنانے والی لائبریری شامل کی گئی ہے -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #004d40; --secondary-color: #e8f5e9;
            --fail-color: #ffebee; --fail-border: #e57373;
            --top-student-color: #dcedc8; --header-text-color: white; --border-color: #cfd8dc;
        }
        body { font-family: 'Noto Nastaliq Urdu', 'Segoe UI', Tahoma, sans-serif; background-color: var(--secondary-color); margin: 0; padding: 10px; }
        .container { max-width: 1200px; margin: auto; }
        .app-card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid #e0e0e0; }
        .header-info { text-align: center; padding: 10px; margin-bottom: 20px; }
        .header-info input { background: #f5f5f5; border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; text-align: center; font-size: 1.1em; margin: 5px; max-width: 280px; font-family: 'Noto Nastaliq Urdu', sans-serif; }
        .controls-panel { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .class-tabs { display: flex; gap: 10px; flex-wrap: wrap; flex-grow: 1; }
        .class-tab { padding: 8px 15px; background: #c8e6c9; border-radius: 6px; cursor: pointer; border: 1px solid #a5d6a7; transition: all 0.3s; }
        .class-tab.active { background: var(--primary-color); color: var(--header-text-color); font-weight: bold; border-color: var(--primary-color); }
        .add-btn { background: #28a745; color: white; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 22px; cursor: pointer; line-height: 38px; text-align: center; flex-shrink: 0; }
        .result-grid-container { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: center; min-width: 80px; }
        thead th { background-color: var(--primary-color); color: var(--header-text-color); position: sticky; top: 0; z-index: 10; }
        th.paper-name, th.paper-marks { font-weight: normal; background-color: #00695c; }
        thead input.subject-name-input { color: var(--header-text-color); background: transparent; border: none; border-bottom: 1px dashed #b2dfdb; border-radius: 0; padding: 5px; text-align: center; width: 100%; box-sizing: border-box; font-size: 1em; font-family: 'Noto Nastaliq Urdu', sans-serif; }
        tbody input[type="text"], tbody input[type="number"] { width: 100%; padding: 8px; text-align: center; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: 'Segoe UI', Tahoma; }
        .fail-mark { background-color: var(--fail-color) !important; border-color: var(--fail-border) !important; }
        .top-student td { background-color: var(--top-student-color) !important; }
        .summary-footer { margin-top: 20px; padding: 15px; background: var(--primary-color); color: white; border-radius: 8px; text-align: center; font-size: 1.2em; }
        .action-buttons { padding: 15px; text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .action-buttons button { padding: 10px 25px; font-size: 1em; border-radius: 6px; border: none; color: white; cursor: pointer; transition: opacity 0.3s; }
        .action-buttons button:hover { opacity: 0.9; }
        .action-cell button { font-size: 0.8em; padding: 4px 8px; background-color: #00796b; color:white; border:none; border-radius: 4px; cursor:pointer;}
        
        /* Print Specific Styles */
        @media print {
            body, .container { margin: 0; padding: 0; background: #fff; box-shadow: none; font-size: 11pt; }
            .app-card { border: none; box-shadow: none; padding: 0; margin-bottom: 10px; }
            .action-buttons, .controls-panel-card, .add-student-row, .action-cell { display: none; }
            
            /* Convert inputs to plain text for printing */
            .header-info input, tbody input, thead input.subject-name-input {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                box-shadow: none !important;
                font-size: inherit !important;
                text-align: center;
                white-space: normal;
            }

            table {
                font-size: 10pt;
                table-layout: auto;
                width: 100%;
                page-break-after: auto;
            }
            th, td {
                padding: 5px 3px !important;
                min-width: auto;
                word-wrap: break-word;
                white-space: normal;
            }
            thead th {
                background-color: var(--primary-color) !important;
                -webkit-print-color-adjust: exact;
                color: var(--header-text-color) !important;
                print-color-adjust: exact;
                position: static;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            .result-grid-container {
                overflow: visible;
                border: none;
            }
            #mainContent {
                border: 2px solid #000;
                padding: 10px;
            }
            .summary-footer {
                padding: 8px !important;
                font-size: 1.1em;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: var(--primary-color) !important;
                color: white !important;
            }
            
            /* Header info for print */
            .header-info {
                margin-bottom: 10px;
                padding-bottom: 5px;
                border-bottom: 1px solid #ccc;
            }
            .header-info input {
                display: block;
                width: 100%;
                margin: 0 auto 5px auto;
                font-size: 1.2em;
            }
            
            @page {
                size: A4 portrait;
                margin: 0.75in 0.5in;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-card controls-panel-card">
            <div class="controls-panel">
                <div id="classTabs" class="class-tabs"></div>
                <button id="addClassBtn" class="add-btn" title="نیا درجہ شامل کریں">+</button>
            </div>
        </div>
        <div class="app-card" id="mainContent">
            <div class="header-info">
                <input type="text" id="madrasaName">
                <input type="text" id="className">
                <input type="text" id="examName" placeholder="امتحان کی قسم اور سال">
            </div>
            <div class="result-grid-container">
                <table id="resultGrid">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="summaryFooter" class="summary-footer"></div>
        </div>
        <div class="action-buttons">
            <button id="saveDataBtn" style="background-color: #007bff;">محفوظ کریں</button>
            <button id="printBtn" style="background-color: #6f42c1;">پوری لسٹ پرنٹ کریں</button>
            <button id="backupBtn" style="background-color: #5a6268;">بیک اپ بنائیں</button>
            <button id="restoreBtn" style="background-color: #28a745;">ڈیٹا بحال کریں</button>
            <button id="resetBtn" style="background-color: #dc3545;">درجہ ری سیٹ کریں</button>
        </div>
        <input type="file" id="restoreInput" style="display: none;" accept=".json">
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const classTabsContainer = document.getElementById('classTabs'), addClassBtn = document.getElementById('addClassBtn'),
              resultGrid = document.getElementById('resultGrid'), summaryFooter = document.getElementById('summaryFooter');
        let db = {}, activeClassIndex = 0;
        const paperNames = ["پہلا پرچہ", "دوسرا پرچہ", "تیسرا پرچہ", "چوتھا پرچہ", "پانچواں پرچہ", "چھٹا پرچہ"];
        
        const getActiveClass = () => db.classes[activeClassIndex];
        const createNewClassObject = (className, studentCount = 0) => {
            const newClass = {
                header: { madrasa: "جامعہ انور القران", class: className, exam: "" },
                subjectNames: ["", "", "", "", "", ""], students: []
            };
            for(let i = 0; i < studentCount; i++) {
                newClass.students.push({ rollNo: '', name: '', marks: ['', '', '', '', '', ''] });
            }
            return newClass;
        };

        function loadData() {
            const data = localStorage.getItem('madrasaResultSystem');
            db = data ? JSON.parse(data) : { classes: [], activeClassIndex: 0 };
            if (db.classes.length === 0) db.classes.push(createNewClassObject("موقف علیہ بنین", 0)); // Default class with 0 students
            activeClassIndex = db.activeClassIndex || 0;
            renderAll();
        }

        function saveData() {
            const classData = getActiveClass();
            classData.header.madrasa = document.getElementById('madrasaName').value;
            classData.header.class = document.getElementById('className').value;
            classData.header.exam = document.getElementById('examName').value;
            db.activeClassIndex = activeClassIndex;
            localStorage.setItem('madrasaResultSystem', JSON.stringify(db));
            alert('ڈیٹا محفوظ ہو گیا!');
        }

        function renderAll() { renderClassTabs(); renderGrid(); }

        function renderClassTabs() {
            classTabsContainer.innerHTML = '';
            db.classes.forEach((cls, index) => {
                const tab = document.createElement('div');
                tab.className = 'class-tab';
                tab.textContent = cls.header.class;
                if (index === activeClassIndex) tab.classList.add('active');
                tab.onclick = () => { activeClassIndex = index; renderAll(); };
                classTabsContainer.appendChild(tab);
            });
        }

        function renderGrid() {
            const classData = getActiveClass();
            if (!classData) return;
            
            document.getElementById('madrasaName').value = classData.header.madrasa;
            document.getElementById('className').value = classData.header.class;
            document.getElementById('examName').value = classData.header.exam;

            const thead = resultGrid.querySelector('thead') || resultGrid.createTHead();
            const tbody = resultGrid.querySelector('tbody') || resultGrid.createTBody();
            thead.innerHTML = ''; tbody.innerHTML = '';

            const subjectRow = thead.insertRow(), paperRow = thead.insertRow(), marksRow = thead.insertRow();
            subjectRow.innerHTML = `<th rowspan="3">رول نمبر</th><th rowspan="3">نام طالب علم</th>`;
            for (let i = 0; i < 6; i++) {
                subjectRow.innerHTML += `<th><input class="subject-name-input" type="text" value="${classData.subjectNames[i] || ''}" placeholder="مضمون کا نام" onblur="updateSubjectName(${i}, this.value)"></th>`;
                paperRow.innerHTML += `<th class="paper-name">${paperNames[i]}</th>`;
                marksRow.innerHTML += `<th class="paper-marks">100</th>`;
            }
            subjectRow.innerHTML += `<th colspan="2">حاصل کردہ نمبرات کی تفصیل</th><th rowspan="3">گریڈ</th><th rowspan="3">عمل</th>`;
            paperRow.innerHTML += `<th rowspan="2">مجموعی</th><th rowspan="2">اوسط٪</th>`;

            classData.students.forEach((student, index) => {
                const row = tbody.insertRow();
                
                let rowHTML = `<td><input type="text" value="${student.rollNo || ''}" onblur="updateStudent(${index}, 'rollNo', this.value)"></td>
                               <td><input type="text" value="${student.name || ''}" onblur="updateStudent(${index}, 'name', this.value)"></td>`;
                for (let i = 0; i < 6; i++) {
                    rowHTML += `<td><input type="number" value="${student.marks[i] || ''}" oninput="updateStudent(${index}, 'marks', this.value, ${i})"></td>`;
                }
                rowHTML += `<td class="total"></td><td class="percentage"></td><td class="grade"></td><td class="action-cell"><button onclick="printStudentCard(${index})">کارڈ PDF</button></td>`;
                row.innerHTML = rowHTML;
            });

            const addRow = tbody.insertRow();
            addRow.className = 'add-student-row';
            addRow.innerHTML = `<td colspan="12"><button class="add-btn" onclick="addStudent()">+</button> طالب علم شامل کریں</td>`;

            calculateResults();
        }

        function calculateResults() {
            const classData = getActiveClass();
            let passCount = 0;
            let topStudentInfo = { index: -1, obtainedMarks: -1 };

            classData.students.forEach((student, index) => {
                const row = resultGrid.rows[index + 3]; 
                let obtainedMarks = 0;
                let allMarksEntered = true; 
                for (let i = 0; i < 6; i++) {
                    const mark = student.marks[i]; 
                    if (mark === null || mark === undefined || mark === '') { 
                        allMarksEntered = false;
                        if (row && row.cells[i + 2] && row.cells[i + 2].querySelector('input')) {
                            row.cells[i + 2].querySelector('input').classList.remove('fail-mark');
                        }
                    } else {
                        obtainedMarks += parseInt(mark);
                        if (row && row.cells[i + 2] && row.cells[i + 2].querySelector('input')) {
                            row.cells[i + 2].querySelector('input').classList.toggle('fail-mark', (parseInt(mark) < 40));
                        }
                    }
                }
                
                const isFail = allMarksEntered && obtainedMarks < 240; 
                if (allMarksEntered && !isFail) {
                    passCount++;
                    if (obtainedMarks > topStudentInfo.obtainedMarks) {
                        topStudentInfo = { index, obtainedMarks };
                    }
                } else if (!allMarksEntered) {
                    if (row) row.classList.remove('top-student');
                }
                
                const percentage = allMarksEntered ? (obtainedMarks / 600) * 100 : 0; 
                if (row) {
                    row.cells[8].textContent = allMarksEntered ? obtainedMarks : 'نامکمل';
                    row.cells[9].textContent = allMarksEntered ? percentage.toFixed(1) + '%' : 'نامکمل';
                    row.cells[10].textContent = allMarksEntered ? getGrade(obtainedMarks) : 'نامکمل';
                    row.classList.remove('top-student'); 
                }
            });

            if (topStudentInfo.index !== -1) {
                const topStudentRow = resultGrid.rows[topStudentInfo.index + 3]; 
                if (topStudentRow) {
                    topStudentRow.classList.add('top-student');
                }
            }
            summaryFooter.textContent = `نتیجہ: کامیاب: ${passCount} - ناکام: ${classData.students.length - passCount}`;
        }
        
        function getGrade(obtainedMarks) {
            if (obtainedMarks < 240) return 'راسب';
            const p = (obtainedMarks / 600) * 100;
            if (p >= 80) return 'ممتاز';
            if (p >= 61) return 'جید جداً';
            if (p >= 50) return 'جید';
            return 'مقبول';
        }
        
        window.updateSubjectName = (i, v) => getActiveClass().subjectNames[i] = v;
        window.updateStudent = (index, field, value, paperIndex = null) => {
            const student = getActiveClass().students[index];
            if (field === 'marks') {
                if (!student.marks) student.marks = [];
                student.marks[paperIndex] = value === '' ? '' : parseInt(value); 
            } else {
                student[field] = value;
            }
            calculateResults();
        };
        window.addStudent = () => {
            getActiveClass().students.push({ rollNo: '', name: '', marks: ['', '', '', '', '', ''] });
            renderGrid();
        };

        addClassBtn.addEventListener('click', () => {
            const className = prompt("نئے درجہ کا نام درج کریں:", "درجہ جدید");
            if (className) {
                let studentCount = prompt("اس درجے میں کتنے طالب علم شامل کرنا چاہتے ہیں؟ (عدد درج کریں)", "0");
                studentCount = parseInt(studentCount);
                if (isNaN(studentCount) || studentCount < 0) {
                    studentCount = 0; // Default to 0 if invalid input
                }
                db.classes.push(createNewClassObject(className, studentCount));
                activeClassIndex = db.classes.length - 1;
                renderAll();
            }
        });

        // ## پرنٹ فنکشن کو درست کر دیا گیا ہے ##
        window.printStudentCard = (index) => {
            const classData = getActiveClass();
            const student = classData.students[index];
            let obtainedMarks = 0;
            let tableRows = '';
            let allMarksEntered = true;

            for(let i=0; i<6; i++) {
                const mark = student.marks[i];
                let displayMark = '';

                if (mark === null || mark === undefined || mark === '') {
                    displayMark = 'غیر موجود';
                    allMarksEntered = false;
                } else {
                    displayMark = mark;
                    obtainedMarks += parseInt(mark);
                }
                tableRows += `<tr><td>${classData.subjectNames[i] || `مضمون ${i+1}`}</td><td>${paperNames[i]}</td><td>100</td><td>${displayMark}</td></tr>`;
            }

            const percentage = allMarksEntered ? ((obtainedMarks / 600) * 100).toFixed(1) : 'نامکمل';
            const grade = allMarksEntered ? getGrade(obtainedMarks) : 'نامکمل';
            const totalMarksDisplay = allMarksEntered ? `${obtainedMarks} / 600` : 'نامکمل';


            const cardHTML = `
                <html><head><title>کشف الدرجات - ${student.name || ''}</title>
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Noto Nastaliq Urdu', sans-serif; direction: rtl; margin: 0; padding: 0; font-size: 11pt; }
                    .card-container { 
                        width: 90%; 
                        max-width: 700px; 
                        margin: 20px auto; 
                        padding: 25px; 
                        border: 8px double #004d40; 
                        box-sizing: border-box; 
                        page-break-after: always; /* Ensure each card is on a new page */
                    }
                    .header { text-align: center; margin-bottom: 20px; }
                    h1 { font-size: 24pt; margin: 0; color: #004d40; }
                    h2 { font-size: 18pt; margin: 0; color: #00695c; }
                    .student-info { 
                        margin-bottom: 20px; 
                        font-size: 14pt; 
                        line-height: 1.6; 
                    }
                    .student-info div { /* Changed from span to div for block behavior */
                        text-align: right;
                        margin-bottom: 5px; /* Add some space between info lines */
                    }
                    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                    th, td { border: 1px solid #333; padding: 8px; text-align: center; }
                    th { background-color: #e0e0e0; color: #333; }
                    .summary { margin-top: 20px; font-size: 14pt; line-height: 1.8; text-align: center; }
                    .signatures { margin-top: 50px; display: block; text-align: center; font-size: 12pt; } /* Changed to block for easier print handling */
                    .signatures div { /* Changed from span to div */
                        width: 45%; /* Keep width for styling */
                        display: inline-block; /* Make them appear side-by-side but allow wrapping */
                        text-align: center; 
                        border-top: 1px dashed #333; 
                        padding-top: 10px; 
                        margin: 0 10px; /* Add some margin between them */
                    }
                    @page { 
                        size: A4 portrait; 
                        margin: 0.5in; 
                    }
                </style>
                </head><body>
                    <div class="card-container">
                        <div class="header">
                            <h1>${classData.header.madrasa}</h1>
                            <h2>${classData.header.exam}</h2>
                        </div>
                        <div class="student-info">
                            <div><strong>رول نمبر:</strong> ${student.rollNo || ''}</div>
                            <div><strong>نام:</strong> ${student.name || ''}</div>
                            <div><strong>درجہ:</strong> ${classData.header.class}</div>
                        </div>
                        <table>
                            <thead><tr><th>مضمون</th><th>پرچہ</th><th>کل نمبر</th><th>حاصل کردہ نمبر</th></tr></thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                        <div class="summary">
                            <p><strong>مجموعی نمبرات:</strong> ${totalMarksDisplay} &nbsp;&nbsp;&nbsp; <strong>فیصد:</strong> ${percentage}% &nbsp;&nbsp;&nbsp; <strong>گریڈ:</strong> ${grade}</p>
                        </div>
                        <div class="signatures">
                            <div>دستخط استاد</div>
                            <div>دستخط مہتمم</div>
                        </div>
                    </div>
                </body></html>`;
            
            const opt = {
                margin:       [0.5, 0.5, 0.5, 0.5], // Top, Right, Bottom, Left (changed order in v0.10.0 for consistency)
                filename:     `StudentCard_${student.name || student.rollNo || 'نامعلوم'}.pdf`, 
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, logging: false, scrollY: 0 }, // Added scrollY: 0
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            // HTML سے PDF بنا کر محفوظ کریں
            html2pdf().from(cardHTML).set(opt).save();
        };

        document.getElementById('saveDataBtn').addEventListener('click', saveData);
        
        document.getElementById('printBtn').addEventListener('click', () => {
            document.querySelectorAll('.action-buttons, .controls-panel-card, .add-student-row, .action-cell').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('tbody input[type="text"], tbody input[type="number"], .header-info input, thead input.subject-name-input').forEach(input => {
                input.setAttribute('data-original-value', input.value);
                input.value = input.value;
                input.style.border = 'none';
                input.style.background = 'transparent';
            });

            window.print();

            setTimeout(() => {
                document.querySelectorAll('.action-buttons, .controls-panel-card, .add-student-row, .action-cell').forEach(el => {
                    el.style.display = '';
                });
                document.querySelectorAll('tbody input[type="text"], tbody input[type="number"], .header-info input, thead input.subject-name-input').forEach(input => {
                    input.value = input.getAttribute('data-original-value');
                    input.removeAttribute('data-original-value');
                    input.style.border = '';
                    input.style.background = '';
                });
            }, 500);
        });


        const restoreInput = document.getElementById('restoreInput');
        document.getElementById('resetBtn').addEventListener('click', () => {
            if(confirm("کیا آپ واقعی اس درجے کے تمام طلباء کے نمبرات ری سیٹ کرنا چاہتے ہیں؟ رول نمبر اور نام برقرار رہیں گے۔")) {
                getActiveClass().students.forEach(student => {
                    student.marks = ['', '', '', '', '', '']; // Only reset marks to empty strings
                });
                renderGrid(); // Re-render to show cleared marks
            }
        });
        document.getElementById('backupBtn').addEventListener('click', () => {
            saveData(); const dataStr = JSON.stringify(db, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement("a");
            a.href = url; a.download = `MadrasaBackup-${new Date().toISOString().slice(0,10)}.json`;
            a.click(); URL.revokeObjectURL(url);
        });
        document.getElementById('restoreBtn').addEventListener('click', () => restoreInput.click());
        restoreInput.addEventListener('change', event => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const restoredDb = JSON.parse(e.target.result);
                    if (confirm("کیا آپ واقعی ڈیٹا بحال کرنا چاہتے ہیں؟")) {
                        db = restoredDb; activeClassIndex = db.activeClassIndex || 0;
                        saveData(); renderAll();
                    }
                } catch (err) { alert("فائل خراب ہے۔"); }
            };
            reader.readAsText(file); restoreInput.value = '';
        });
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service worker registered.', reg))
                    .catch(err => console.log('Service worker registration failed: ', err));
            });
        }

        loadData();
    });
    </script>
</body>
</html>
